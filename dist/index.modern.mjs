import"isomorphic-unfetch";function t(){return t=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t},t.apply(this,arguments)}async function e(t){let e="";for(let r=0;r<t;r++)e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return e}async function r(){return fetch("https://api.ipify.org?format=json").then(t=>t.json()).then(t=>{const e=t.ip;return console.log("IP Address:",e),e}).catch(t=>{console.error("Error fetching IP address:",t)})}class n{constructor(t){var r,n;this.apiKey=void 0,this.clientKey=void 0,this.requestId=void 0,this.baseUrl=void 0,this.apiKey=t.apiKey,this.clientKey=t.clientKey,this.requestId=null!=(r=t.requestId)?r:e(12),this.baseUrl=null!=(n=t.baseUrl)?n:"https://api-sandbox.qorcommerce.io/v3"}async request(e,r,n){const s=new URL(`${this.baseUrl}${e}`);if(r){const t=new URLSearchParams;Object.entries(r).forEach(([e,r])=>{t.append(e,r)}),s.search=new URLSearchParams(t).toString()}const a=t({},n,{headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"x-client-key":this.clientKey,"x-request-id":this.requestId}});console.log("Sending Request",JSON.stringify(`${s}`),a);const i=await fetch(s,a);if(i.ok)return i.json();throw console.error("ERROR",i.statusText),new Error(i.statusText)}}const s="/payment/transactions";class a extends n{async fetchPaymentTransactionById(t){const e=await this.request(`/payment/transaction/${t}`);return{status:e.status,code:e.code,message:e.message,data:e.data[0]}}listPaymentTransactions(t){return this.request(`${s}`,t)}listPaymentTransactionsByProfileId(t){return this.request(`/payment/transactions/profile/${t}`)}listPaymentTransactionsByBatchId(t){return this.request(`/payment/transactions/batch/${t}`)}fetchAchTransactionById(t){return this.request(`/ach/transactions/${t}`)}listAchTransactions(t){return this.request(`${s}`,t)}}class i extends n{fetchMarketplaceTransactionByBatchId(t){return this.request(`payment/transactions/mp/batch/${t}`)}createMarketplaceMerchantAccount(t){return this.request("/channels/new_marketplace_merchant",{method:"POST",body:JSON.stringify({data:t})})}}const o="payment/transaction/proof_of_delivery";class c extends n{listProofOfDelivery(t){return this.request(`${o}`,t)}fetchProofOfDeliveryById(t){return this.request(`${o}/${t}`)}createProofOfDelivery(t){return this.request(`/${o}`,{method:"POST",body:JSON.stringify(t)})}patchProofOfDelivery(t){return this.request(`/${o}`,{method:"PATCH",body:JSON.stringify(t)})}deleteProofOfDelivery(t){return this.request(`/${o}/${t}`,{method:"DELETE"})}}const l=["card_detail","billing","customer"];class d extends n{processManualCardSale(n){var s;const{card_detail:a,billing:i,customer:o}=n,c=function(t,e){if(null==t)return{};var r,n,s={},a=Object.keys(t);for(n=0;n<a.length;n++)e.indexOf(r=a[n])>=0||(s[r]=t[r]);return s}(n,l);if(!function(t){const e=t.replace(/[\s-]/g,"");if(!/^\d+$/.test(e)||!(e.length>=13&&e.length<=19))return!1;let r=0,n=!1;for(let t=e.length-1;t>=0;t--){let s=parseInt(e.charAt(t));n&&(s*=2,s=s>9?s-9:s),r+=s,n=!n}return r%10==0}(null==a?void 0:a.number))throw new Error("Invalid credit card number");if(!function(t,e){const r=new Date,n=r.getMonth()+1,s=r.getFullYear();return!(e>s+10)&&(e>s||e===s&&t>=n)}(null==a?void 0:a.exp_month,null==a?void 0:a.exp_year))throw new Error("Invalid credit card expiration date");const d=function(t){const e=t.replace(/[\s-]/g,"");let r="";return r=/^4/.test(e)?"Visa":/^5[1-5]/.test(e)?"Mastercard":/^3[47]/.test(e)?"American Express":/^6(?:011|5)/.test(e)?"Discover":/^(?:2131|1800|35\d{3})/.test(e)?"JCB":/^3(?:0[0-5]|[68])/.test(e)?"Diners Club":/^(?:5[0678]|6304|6390|67\d{2})/.test(e)?"Maestro":"Unknown",r}(null==a?void 0:a.number);if(!d)throw new Error("Invalid credit card brand");if("American Express"===d&&4!==(null==a?void 0:a.cvv.toString().length)||3!==(null==a?void 0:a.cvv.toString().length))throw new Error("Invalid card validation number (cvv)");return this.request("/payment/sale/manual",{method:"POST",body:JSON.stringify({transaction_data:t({mid:n.mid,amount:n.amount,orderId:n.orderid||"ORDER_"+e(8),invoice_id:n.invoice_id,ipaddress:n.ip_address||r(),creditcard:null==a?void 0:a.number,cvv:null==a?void 0:a.cvv,month:null==a?void 0:a.exp_month,year:null==a?void 0:a.exp_year,cardfullname:null==a||null==(s=a.cardholder)?void 0:s.toUpperCase(),bzip:null==i?void 0:i.postal_code,baddress:null==i?void 0:i.street_1,baddress2:null==i?void 0:i.street_2,bcity:null==i?void 0:i.city,bstate:null==i?void 0:i.state_code,bcountry:null==i?void 0:i.country_code,currency:n.currency||"USD",risk_score:n.risk_score,store_card:n.store_card?1:0,reference_id:n.reference_id,topt:n.topt,tid:n.tid,cfirstname:null==o?void 0:o.first_name,clastname:null==o?void 0:o.last_name,cemail:null==o?void 0:o.email,cphone:null==o?void 0:o.phone,metadata:n.meta_data},c)})})}}class u{constructor(t){this.payments=void 0,this.transactions=void 0,this.marketplace=void 0,this.proofOfDelivery=void 0,this.payments=new d(t),this.transactions=new a(t),this.marketplace=new i(t),this.proofOfDelivery=new c(t)}}export{u as QorDirectSDK};
