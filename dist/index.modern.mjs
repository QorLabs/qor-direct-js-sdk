import"isomorphic-unfetch";function e(){return e=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},e.apply(this,arguments)}function t(e){let t="";for(let r=0;r<e;r++)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return t}async function r(){return fetch("https://api.ipify.org?format=json").then(e=>e.json()).then(e=>{const t=e.ip;return console.log("IP Address:",t),t}).catch(e=>{console.error("Error fetching IP address:",e)})}class n{constructor(e){var r,n;this.apiKey=void 0,this.clientKey=void 0,this.requestId=void 0,this.baseUrl=void 0,this.apiKey=e.apiKey,this.clientKey=e.clientKey,this.requestId=null!=(r=e.requestId)?r:t(12),this.baseUrl=null!=(n=e.baseUrl)?n:"https://api-sandbox.qorcommerce.io/v3"}async request(t,r,n){const a=new URL(`${this.baseUrl}${t}`);if(r){const e=new URLSearchParams;Object.entries(r).forEach(([t,r])=>{e.append(t,r)}),a.search=new URLSearchParams(e).toString()}const s=e({},n,{headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"x-client-key":this.clientKey,"x-request-id":this.requestId}});console.log("Sending Request",JSON.stringify(`${a}`),s);const i=await fetch(a,s);if(i.ok)return i.json();throw console.error("ERROR",i.statusText),new Error(i.statusText)}}const a="/payment/transactions";class s extends n{async fetchPaymentTransactionById(e){const t=await this.request(`/payment/transaction/${e}`);return{status:t.status,code:t.code,message:t.message,data:t.data[0]}}listPaymentTransactions(e){return this.request(`${a}`,e)}listPaymentTransactionsByProfileId(e){return this.request(`/payment/transactions/profile/${e}`)}listPaymentTransactionsByBatchId(e){return this.request(`/payment/transactions/batch/${e}`)}fetchAchTransactionById(e){return this.request(`/ach/transactions/${e}`)}listAchTransactions(e){return this.request(`${a}`,e)}}class i extends n{fetchMarketplaceTransactionByBatchId(e){return this.request(`payment/transactions/mp/batch/${e}`)}createMarketplaceMerchantAccount(e){return this.request("/channels/new_marketplace_merchant",{method:"POST",body:JSON.stringify({data:e})})}}const o="payment/transaction/proof_of_delivery";class c extends n{listProofOfDelivery(e){return this.request(`${o}`,e)}fetchProofOfDeliveryById(e){return this.request(`${o}/${e}`)}createProofOfDelivery(e){return this.request(`/${o}`,{method:"POST",body:JSON.stringify(e)})}patchProofOfDelivery(e){return this.request(`/${o}`,{method:"PATCH",body:JSON.stringify(e)})}deleteProofOfDelivery(e){return this.request(`/${o}/${e}`,{method:"DELETE"})}}const d=["token_detail","card_detail","track_detail","customer_detail","discount_detail","items_detail","shipping_detail","three_ds"];class l extends n{async processCreditCard(n){var a;const{token_detail:s,card_detail:i,track_detail:o,customer_detail:c,items_detail:l,shipping_detail:u,three_ds:p}=n,h=function(e,t){if(null==e)return{};var r,n,a={},s=Object.keys(e);for(n=0;n<s.length;n++)t.indexOf(r=s[n])>=0||(a[r]=e[r]);return a}(n,d);if(!n.type)throw new Error('You must provide a processing type.  Accepted values are "sale" and "authorize"');if("SALE"!==n.type.toUpperCase()&&"AUTHORIZE"!==n.type.toUpperCase())throw new Error("Invalid processing type.  Accepted 'type' values are 'sale' and 'authorize'");if(!Object.keys(i)&&!Object.keys(s)&&!Object.keys(o)||Object.keys(i)&&Object.keys(s)||Object.keys(i)&&Object.keys(o)||Object.keys(s)&&Object.keys(o))throw new Error("You must provide only one of 'card_detail', 'token_detail', or 'track_detail' objects with required values to process a payment");if(Object.keys(i)&&await async function(e){if(!e.number)return new Error("A 'card_detail.number' value is required");if(!e.exp_month)return new Error("A 'card_detail.exp_month' value is required");if(!e.exp_year)return new Error("A 'card_detail.exp_year' value is required");if(!e.cvv)return new Error("A 'card_detail.cvv' value is required");if(!function(e){const t=e.replace(/[\s-]/g,"");if(!/^\d+$/.test(t)||!(t.length>=13&&t.length<=19))return!1;let r=0,n=!1;for(let e=t.length-1;e>=0;e--){let a=parseInt(t.charAt(e));n&&(a*=2,a=a>9?a-9:a),r+=a,n=!n}return r%10==0}(e.number))return new Error("Invalid 'card_detail.number' value");if(!function(e,t){const r=new Date,n=r.getMonth()+1,a=r.getFullYear();return!(t>a+10)&&(t>a||t===a&&e>=n)}(e.exp_month,e.exp_year))return new Error("Invalid 'card_detail.exp_month' or 'card_detail.exp_year' value");const t=function(e){const t=e.replace(/[\s-]/g,"");let r="";return r=/^4/.test(t)?"Visa":/^5[1-5]/.test(t)?"Mastercard":/^3[47]/.test(t)?"American Express":/^6(?:011|5)/.test(t)?"Discover":/^(?:2131|1800|35\d{3})/.test(t)?"JCB":/^3(?:0[0-5]|[68])/.test(t)?"Diners Club":/^(?:5[0678]|6304|6390|67\d{2})/.test(t)?"Maestro":"Unknown",r}(e.number);if(!t)return new Error("Invalid or not supported credit card brand");if("American Express"===t&&4!==e.cvv.toString().length||3!==e.cvv.toString().length)return new Error("Invalid 'card_detail.cvv' value");if(e.store_card&&!e.nickname)throw new Error("You must provide 'card_detail.nickname' to store a card token");return!0}(i).catch(e=>{throw new Error(e)}),null!=i&&i.store_card&&(null==c||!c.email))throw new Error("You must provide a 'customer_detail.email' address to store a card token");if(Object.keys(s)&&!s.token)throw new Error("You must provide a 'token_detail.token' value");if(Object.keys(s)&&!s.cvv)throw new Error("You must provide a 'token_detail.cvv' value");if(n.send_receipt&&(null==c||!c.email))throw new Error("You must provide a 'customer_detail.email' value to send a payment receipt");const y="SALE"===n.type.toUpperCase()?"payment/sale/manual":"payment/sale/authorize",v=e({mid:n.mid,amount:n.total_amount,total_tax:n.total_tax_amount,ipaddress:n.ip_address||r(),currency:n.currency||"USD",orderId:n.order_id||"ORDER_"+t(12),invoiceId:n.invoice_id,purchase_order:n.purchase_order,risk_score:n.risk_score,reference_id:n.reference_id,topt:n.topt,tid:n.terminal_id,metadata:n.meta_data,send_rcpt:!0===n.send_receipt?1:0,shipping_amount:null==u?void 0:u.amount,shipping_zip:null==u?void 0:u.postal_code,shipping_country:null==u?void 0:u.country_code,creditcard:(null==i?void 0:i.number)||(null==s?void 0:s.token),cvv:(null==i?void 0:i.cvv)||s.cvv,month:null==i?void 0:i.exp_month,year:null==i?void 0:i.exp_year,cardfullname:null==i||null==(a=i.cardholder)?void 0:a.toUpperCase(),bzip:null==i?void 0:i.postal_code,baddress:null==i?void 0:i.street_1,baddress2:null==i?void 0:i.street_2,bcity:null==i?void 0:i.city,bstate:null==i?void 0:i.state_code,bcountry:null==i?void 0:i.country_code,trackdata:o.track,ksnTrack:o.ksn,line_items:l,response_3DS:p.response,CAVV:p.CAVV,ECIFlag:p.ECIFlag,XID:p.XID,store_card:!0===(null==i?void 0:i.store_card)?1:0,nickname:null==i?void 0:i.nickname,cfirstname:null==c?void 0:c.first_name,clastname:null==c?void 0:c.last_name,cemail:null==c?void 0:c.email,cphone:null==c?void 0:c.phone,cwebaddress:null==c?void 0:c.website},h);return this.request(`/${y}`,{method:"POST",body:JSON.stringify({transaction_data:v})})}}class u{constructor(e){this.payments=void 0,this.transactions=void 0,this.marketplace=void 0,this.proofOfDelivery=void 0,this.payments=new l(e),this.transactions=new s(e),this.marketplace=new i(e),this.proofOfDelivery=new c(e)}}export{u as QorDirectSDK};
