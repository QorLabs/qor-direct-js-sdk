import"isomorphic-unfetch";function e(){return e=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},e.apply(this,arguments)}function t(e,t){if(null==e)return{};var r,n,s={},a=Object.keys(e);for(n=0;n<a.length;n++)t.indexOf(r=a[n])>=0||(s[r]=e[r]);return s}async function r(e){let t="";for(let r=0;r<e;r++)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return t}async function n(){return fetch("https://api.ipify.org?format=json").then(e=>e.json()).then(e=>{const t=e.ip;return console.log("IP Address:",t),t}).catch(e=>{console.error("Error fetching IP address:",e)})}class s{constructor(e){var t,n;this.apiKey=void 0,this.clientKey=void 0,this.requestId=void 0,this.baseUrl=void 0,this.apiKey=e.apiKey,this.clientKey=e.clientKey,this.requestId=null!=(t=e.requestId)?t:r(12),this.baseUrl=null!=(n=e.baseUrl)?n:"https://api-sandbox.qorcommerce.io/v3"}async request(t,r,n){const s=new URL(`${this.baseUrl}${t}`);if(r){const e=new URLSearchParams;Object.entries(r).forEach(([t,r])=>{e.append(t,r)}),s.search=new URLSearchParams(e).toString()}const a=e({},n,{headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"x-client-key":this.clientKey,"x-request-id":this.requestId}});console.log("Sending Request",JSON.stringify(`${s}`),a);const i=await fetch(s,a);if(i.ok)return i.json();throw console.error("ERROR",i.statusText),new Error(i.statusText)}}const a="/payment/transactions";class i extends s{async fetchPaymentTransactionById(e){const t=await this.request(`/payment/transaction/${e}`);return{status:t.status,code:t.code,message:t.message,data:t.data[0]}}listPaymentTransactions(e){return this.request(`${a}`,e)}listPaymentTransactionsByProfileId(e){return this.request(`/payment/transactions/profile/${e}`)}listPaymentTransactionsByBatchId(e){return this.request(`/payment/transactions/batch/${e}`)}fetchAchTransactionById(e){return this.request(`/ach/transactions/${e}`)}listAchTransactions(e){return this.request(`${a}`,e)}}class o extends s{fetchMarketplaceTransactionByBatchId(e){return this.request(`payment/transactions/mp/batch/${e}`)}createMarketplaceMerchantAccount(e){return this.request("/channels/new_marketplace_merchant",{method:"POST",body:JSON.stringify({data:e})})}}const c="payment/transaction/proof_of_delivery";class d extends s{listProofOfDelivery(e){return this.request(`${c}`,e)}fetchProofOfDeliveryById(e){return this.request(`${c}/${e}`)}createProofOfDelivery(e){return this.request(`/${c}`,{method:"POST",body:JSON.stringify(e)})}patchProofOfDelivery(e){return this.request(`/${c}`,{method:"PATCH",body:JSON.stringify(e)})}deleteProofOfDelivery(e){return this.request(`/${c}/${e}`,{method:"DELETE"})}}const l=["card_detail","billing","customer","discount"],u=["track_data","customer","discount"];class h extends s{processManualCardSale(s){var a;const{card_detail:i,billing:o,customer:c,discount:d}=s,u=t(s,l);if(!function(e){const t=e.replace(/[\s-]/g,"");if(!/^\d+$/.test(t)||!(t.length>=13&&t.length<=19))return!1;let r=0,n=!1;for(let e=t.length-1;e>=0;e--){let s=parseInt(t.charAt(e));n&&(s*=2,s=s>9?s-9:s),r+=s,n=!n}return r%10==0}(null==i?void 0:i.number))throw new Error("Invalid credit card number");if(!function(e,t){const r=new Date,n=r.getMonth()+1,s=r.getFullYear();return!(t>s+10)&&(t>s||t===s&&e>=n)}(null==i?void 0:i.exp_month,null==i?void 0:i.exp_year))throw new Error("Invalid credit card expiration date");const h=function(e){const t=e.replace(/[\s-]/g,"");let r="";return r=/^4/.test(t)?"Visa":/^5[1-5]/.test(t)?"Mastercard":/^3[47]/.test(t)?"American Express":/^6(?:011|5)/.test(t)?"Discover":/^(?:2131|1800|35\d{3})/.test(t)?"JCB":/^3(?:0[0-5]|[68])/.test(t)?"Diners Club":/^(?:5[0678]|6304|6390|67\d{2})/.test(t)?"Maestro":"Unknown",r}(null==i?void 0:i.number);if(!h)throw new Error("Invalid credit card brand");if("American Express"===h&&4!==(null==i?void 0:i.cvv.toString().length)||3!==(null==i?void 0:i.cvv.toString().length))throw new Error("Invalid card validation number (cvv)");if(s.send_receipt&&(null==c||!c.email))throw new Error("You must provide a customer email address to send a payment receipt");return this.request("/"+(null!=d&&d.amount||null!=d&&d.percent?"payment/sale/cashdiscount":"payment/sale/manual"),{method:"POST",body:JSON.stringify({transaction_data:e({mid:s.mid,amount:s.amount,orderId:s.order_id||"ORDER_"+r(8),invoiceId:s.invoice_id,ipaddress:s.ip_address||n(),creditcard:null==i?void 0:i.number,cvv:null==i?void 0:i.cvv,month:null==i?void 0:i.exp_month,year:null==i?void 0:i.exp_year,cardfullname:null==i||null==(a=i.cardholder)?void 0:a.toUpperCase(),bzip:null==o?void 0:o.postal_code,baddress:null==o?void 0:o.street_1,baddress2:null==o?void 0:o.street_2,bcity:null==o?void 0:o.city,bstate:null==o?void 0:o.state_code,bcountry:null==o?void 0:o.country_code,currency:s.currency||"USD",risk_score:s.risk_score,store_card:s.store_card?1:0,reference_id:s.reference_id,topt:s.topt,tid:s.terminal_id,cfirstname:null==c?void 0:c.first_name,clastname:null==c?void 0:c.last_name,cemail:null==c?void 0:c.email,cphone:null==c?void 0:c.phone,metadata:s.meta_data,send_rcpt:s.send_receipt},u)})})}processManualCardTokenSale(e){var t,s;return this.request("/payment/sale/token",{method:"POST",body:JSON.stringify({transaction_data:{mid:e.mid,amount:e.amount,creditcard:e.token,cvv:e.cvv,orderId:e.order_id||"ORDER_"+r(8),invoiceId:e.invoice_id,ipaddress:e.ip_address||n(),currency:e.currency||"USD",service_charge:e.service_charge,cash_discount_amount:null==(t=e.discount)?void 0:t.amount,cash_discount_percent:null==(s=e.discount)?void 0:s.percent,risk_score:e.risk_score,reference_id:e.reference_id,topt:e.topt,tid:e.terminal_id,metadata:e.meta_data,send_rcpt:e.send_receipt}})})}processCardTrackSale(s){const{track_data:a,customer:i}=s,o=t(s,u);return this.request("/payment/card/swipe",{method:"POST",body:JSON.stringify({transaction_data:e({mid:s.mid,amount:s.amount,orderId:s.order_id||"ORDER_"+r(8),invoiceId:s.invoice_id,ipaddress:s.ip_address||n(),trackdata:null==a?void 0:a.track,ksnTrack:null==a?void 0:a.ksn,currency:s.currency||"USD",risk_score:s.risk_score,store_card:s.store_card?1:0,reference_id:s.reference_id,topt:s.topt,tid:s.terminal_id,cfirstname:null==i?void 0:i.first_name,clastname:null==i?void 0:i.last_name,cemail:null==i?void 0:i.email,cphone:null==i?void 0:i.phone,metadata:s.meta_data,send_rcpt:s.send_receipt},o)})})}}class m{constructor(e){this.payments=void 0,this.transactions=void 0,this.marketplace=void 0,this.proofOfDelivery=void 0,this.payments=new h(e),this.transactions=new i(e),this.marketplace=new o(e),this.proofOfDelivery=new d(e)}}export{m as QorDirectSDK};
